events {
    # You can leave this block empty or configure specific settings if needed
    worker_connections 1024;
}

http {
    upstream users_service {
        ip_hash;
        server apiphp:80;
    }

    upstream articles_service {
        ip_hash;
        server apiphp:80;
    }

    limit_req_zone $binary_remote_addr zone=user_rate:10m rate=1r/s;

    server {
        listen 81 default_server;
        listen [::]:81 default_server;

        location / {
            proxy_pass http://localhost:81;
        }

        location /api/articles {
            auth_request /api/users/verify;
            auth_request_set $auth_status $upstream_status;
            limit_req zone=user_rate;
            limit_req_status 429;
            proxy_pass http://articles_service;
        }

        location /api/users {
            limit_req zone=user_rate;
            limit_req_status 429;
            proxy_pass http://users_service;
        }
    }
}